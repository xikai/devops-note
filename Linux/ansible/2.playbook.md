# [ansible-playbook](https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html)
* https://github.com/ansible/ansible-examples

* 一个play示例
>#在运行 playbook 时（从上到下执行）,如果一个 host 执行 task 失败,这个 host 将会从整个 playbook 的 rotation 中移除.
```yml
---
- hosts: webservers     #hosts 行的内容是一个或多个组或主机的 patterns,以逗号为分隔符 - hosts: apollo,server,gateway,schedule
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root     #以哪个用户身份ssh到目标主机
  tasks:  #任务列表
  - name: ensure apache is at the latest version    #task任务的名字，在运行 playbook 时,从其输出的任务执行信息中可以很好的辨别出是属于哪一个 task 的. 
    #become: yes            #使用特权用户执行playbook,默认为root
    yum: pkg=httpd state=latest
  - name: write the apache config file
    template: src=/srv/httpd.j2 dest=/etc/httpd.conf
    notify:   # 该配置发生了改动`changed`时，被触发（多个不同task通知changed 也只触发一次）
      - restart apache   #对应handlers的name
  - name: ensure apache is running
    service: name=httpd state=started
  handlers:  # 只有在触发notify事件的时候才会执行里面的任务(最佳的应用场景是用来重启服务,或者触发系统重启操作)
    - name: restart apache
      service: name=httpd state=restarted
```

* 执行playbook
```
ansible-playbook /etc/ansible/playbook-httpd.yml

# 查看执行playbook会影响哪些主机
# ansible-playbook playbook.yml --list-hosts
# 模拟执行
# ansible-playbook playbook.yml --check
```


# [when条件判断](https://docs.ansible.com/ansible/2.9/user_guide/playbooks_conditionals.html)
```
tasks:
  - name: "shutdown Debian flavored systems"
    command: /sbin/shutdown -t now
    when: ansible_os_family == "Debian"
```
* 有些时候你得到一个返回参数的值是一个字符串,并且你还想使用数学操作来比较它
```
tasks:
  - shell: echo "only on Red Hat 6, derivatives, and later"
    #when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int >= 6
    when: 
      - ansible_os_family == "RedHat" 
      - ansible_lsb.major_release|int >= 6
```

* 执行tasks基于变量的布尔值
```
vars:
  epic: true
  monumental: "yes"
```
```
tasks:
  - shell: echo "This certainly isn't epic!"
    when: not epic
  - shell: echo "This certainly is epic!"
    when: epic or monumental|bool
```
* 条件循环
```
tasks:
  - command: echo {{ item }}
    with_items: [ 0, 2, 4, 6, 8, 10 ]
    when: item > 5
```

# 循环
```
- name: add several users
  user: name={{ item }} state=present groups=wheel
  with_items:
     - testuser1
     - testuser2
```
```
- name: add several users
  user: name={{ item.name }} state=present groups={{ item.groups }}
  with_items:
    - { name: 'testuser1', groups: 'wheel' }
    - { name: 'testuser2', groups: 'root' }
```
* 嵌套循环
```
- name: give users access to multiple databases
  mysql_user: name={{ item[0] }} priv={{ item[1] }}.*:ALL append_privs=yes password=foo
  with_nested:
    - [ 'alice', 'bob' ]
    - [ 'clientdb', 'employeedb', 'providerdb' ]
```
* 循环数据集
```
---
alpha: [ 'a', 'b', 'c', 'd' ]
numbers:  [ 1, 2, 3, 4 ]
```
```
tasks:
    - debug: msg="{{ item.0 }} and {{ item.1 }}"
      with_together:
        - "{{alpha}}"
        - "{{numbers}}"
```

* 循环哈希表
```
---
users:
  alice:
    name: Alice Appleworth
    telephone: 123-456-7890
  bob:
    name: Bob Bananarama
    telephone: 987-654-3210
```
```
tasks:
  - name: Print phone records
    debug: msg="User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})"
    with_dict: "{{users}}"
```
* 循环文件列表
```
 # copy each file over that matches the given pattern
    - copy: src={{ item }} dest=/etc/fooapp/ owner=root mode=600
      with_fileglob:
        - /playbooks/files/fooapp/*
```
* 循环整数序列
```
---
- hosts: all
  tasks:
    # create groups
    - group: name=evens state=present
    - group: name=odds state=present

    # create some test users
    - user: name={{ item }} state=present groups=evens
      with_sequence: start=0 end=32 format=testuser%02x

    # create a series of directories with even numbers for some reason
    - file: dest=/var/stuff/{{ item }} state=directory
      with_sequence: start=4 end=16 stride=2

    # a simpler way to use the sequence plugin
    # create 4 groups
    - group: name=group{{ item }} state=present
      with_sequence: count=4
```

# [异步执行和轮训](https://ansible-tran.readthedocs.io/en/latest/docs/playbooks_async.html#)
* vim ansible.cfg
```
[defaults]
forks=100   #设置并发线程数
```
>--forks 参数值过大会更快的触发异步任务.也会加快轮询的效率.
```yml
- name: simulate long running op, allow to run for 45 sec, fire and forget
  command: /bin/sleep 15
  async: 1000    #async 允许异步运行的最大超时时间(秒)，并没有默认值,如果你没有指定 async 关键字,那么任务会以同步的方式运行,这是Ansible的默认行为.
  poll: 30       #轮询异步线程状态的频率.如果你没有为 poll 指定值,那么默认的轮询频率是10秒钟:
```